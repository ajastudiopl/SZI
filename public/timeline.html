<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveSurfer with Editable Cue Points</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }

        #waveform {
            width: 100%;
            height: 200px;
            background-color: #eaeaea;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            position: relative;
        }

        .cue-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: red;
        }

        .cue-label {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            font-size: 12px;
            color: black;
        }

        #timeScale {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 10px;
            position: relative;
            height: 20px;
        }

        #timeScale span {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            font-size: 12px;
            color: #555;
            font-weight: bold;
        }

        button, input[type="file"], #cueList {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #4F4A85;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #383351;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            padding: 10px 20px;
            background-color: #4F4A85;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
            text-align: center;
        }

        .file-input-label:hover {
            background-color: #383351;
        }

        #cueList {
            margin-top: 20px;
            list-style-type: none;
            padding: 0;
        }

        #cueList li {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #cueList li input[type="text"] {
            margin-right: 10px;
            font-size: 14px;
            padding: 5px;
        }

        #cueList li input[type="text"] {
            width: 90px;
        }

        #cueList button {
            background-color: #c0392b;
            padding: 5px 10px;
            font-size: 12px;
        }

        #cueList button:hover {
            background-color: #e74c3c;
        }

        .time-tick {
            position: absolute;
            top: 0;
            font-size: 12px;
            color: #555;
        }

        /* Timer styles */
        #timer {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- Timer showing the current marker time -->
<div id="timer">00:00:00</div>

<div id="waveform"></div>

<div id="timeScale">
    <!-- Time ticks will be rendered here -->
</div>

<!-- Button to play or pause the audio -->
<button id="playPauseBtn">Play</button>

<!-- Label for file input styled like a button -->
<label for="fileInput" class="file-input-label">Choose File</label>
<input type="file" id="fileInput" accept="audio/*" />

<!-- Button to add Cue point -->
<button id="addCueBtn">Add Cue at Current Time</button>

<!-- List of Cues -->
<ul id="cueList">
    <!-- Cues will be dynamically added here -->
</ul>

<script type="module">
import WaveSurfer from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.esm.js'

// Create a WaveSurfer instance
const wavesurfer = WaveSurfer.create({
  container: '#waveform',
  waveColor: '#4F4A85',
  progressColor: '#383351',
  height: 150,
})

// Play or pause functionality with spacebar
document.addEventListener('keydown', (event) => {
  if (event.code === 'Space') {
    event.preventDefault() // Prevent page scrolling
    togglePlayPause()
  }
})

function togglePlayPause() {
  if (wavesurfer.isPlaying()) {
    wavesurfer.pause()
    playPauseBtn.textContent = 'Play'
  } else {
    wavesurfer.play()
    playPauseBtn.textContent = 'Pause'
  }
}

const playPauseBtn = document.getElementById('playPauseBtn')
playPauseBtn.addEventListener('click', () => {
  togglePlayPause()
})

// Handle file upload and load the audio file
const fileInput = document.getElementById('fileInput')
fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0]
  if (file) {
    const objectUrl = URL.createObjectURL(file)
    wavesurfer.load(objectUrl)
    playPauseBtn.textContent = 'Play' // Reset button text
    clearCues() // Clear previous cues when loading new file
  }
})

// Timer showing the current time, updated when clicking on waveform
const timer = document.getElementById('timer')

// Update timer on seek (when clicking waveform)
wavesurfer.on('seek', () => {
  const currentTime = wavesurfer.getCurrentTime()
  timer.textContent = formatTimeWithMillis(currentTime)
})

// Aktualizacja timera po klikniÄ™ciu na waveform
wavesurfer.on('click', () => {
  const currentTime = wavesurfer.getCurrentTime()
  timer.textContent = formatTimeWithMillis(currentTime)
})

// Aktualizuj timer w trakcie odtwarzania
wavesurfer.on('audioprocess', () => {
  const currentTime = wavesurfer.getCurrentTime()
  timer.textContent = formatTimeWithMillis(currentTime)
})

// Handle adding cues
const cueList = document.getElementById('cueList')
const addCueBtn = document.getElementById('addCueBtn')
let cueCount = 0

addCueBtn.addEventListener('click', () => {
  const currentTime = wavesurfer.getCurrentTime()

  // Add cue to the list and on waveform
  addCue(currentTime, `Cue ${cueCount + 1}`)
})

// Function to add Cue marker and list item
function addCue(time, name) {
  cueCount++
  const formattedTime = formatTimeWithMillis(time)
  const cueId = `cue-${cueCount}`

  // Add marker to waveform
  const marker = document.createElement('div')
  marker.classList.add('cue-marker')
  marker.style.left = `${(time / wavesurfer.getDuration()) * 100}%`
  marker.setAttribute('data-time', time)

  // Add cue name label above marker
  const label = document.createElement('div')
  label.classList.add('cue-label')
  label.textContent = name
  marker.appendChild(label)

  document.getElementById('waveform').appendChild(marker)

  // Add to Cue list
  const listItem = document.createElement('li')
  listItem.setAttribute('id', cueId)
  listItem.innerHTML = `
    <input type="text" value="${name}" placeholder="Cue name" />
    <input type="text" value="${formattedTime}" class="time-input" />
    <button class="update-time-btn" data-id="${cueId}">Update Time</button>
    <button data-id="${cueId}" data-time="${time}">Remove</button>`
  cueList.appendChild(listItem)

  // Handle cue removal
  listItem.querySelector('button[data-time]').addEventListener('click', (event) => {
    const cueId = event.target.getAttribute('data-id')
    const cueTime = event.target.getAttribute('data-time')

    // Remove from DOM
    document.getElementById(cueId).remove()
    const markerToRemove = document.querySelector(`.cue-marker[data-time="${cueTime}"]`)
    markerToRemove.remove()
  })

  // Handle cue time update (based on current position)
  const updateTimeBtn = listItem.querySelector('.update-time-btn')
  updateTimeBtn.addEventListener('click', () => {
    const currentTime = wavesurfer.getCurrentTime()
    updateCueTime(cueId, currentTime, marker, label)
  })

  // Handle manual cue time change
  const timeInput = listItem.querySelector('.time-input')
  timeInput.addEventListener('input', (event) => {
    const newTimeStr = event.target.value
    const newTime = parseTime(newTimeStr)
    if (!isNaN(newTime)) {
      updateCueTime(cueId, newTime, marker, label)
    }
  })
}

// Function to update cue marker position when time is changed
function updateCueTime(cueId, newTime, marker, label) {
  if (marker) {
    // Update marker position
    marker.style.left = `${(newTime / wavesurfer.getDuration()) * 100}%`
    marker.setAttribute('data-time', newTime)

    // Update label time
    const cueElement = document.getElementById(cueId)
    const timeInput = cueElement.querySelector('.time-input')
    timeInput.value = formatTimeWithMillis(newTime)
  }
}

// Function to clear all cues (used when loading new audio file)
function clearCues() {
  document.querySelectorAll('.cue-marker').forEach(marker => marker.remove())
  cueList.innerHTML = ''
  cueCount = 0
}

// Function to format time as MM:SS:SS
function formatTimeWithMillis(time) {
  const minutes = Math.floor(time / 60)
  const seconds = Math.floor(time % 60)
  const millis = Math.floor((time % 1) * 100)
  return `${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}:${millis < 10 ? '0' + millis : millis}`
}

// Function to parse time from "MM:SS:SS" format
function parseTime(timeStr) {
  const [minutes, seconds, millis] = timeStr.split(':').map(Number)
  return (minutes * 60) + seconds + (millis / 100)
}

// Add time scale (every 10 seconds) with MM:SS format
function addTimeScale() {
  const timeScale = document.getElementById('timeScale')
  const duration = wavesurfer.getDuration()
  const tickCount = Math.floor(duration)
  const step = 10

  for (let i = 0; i <= tickCount; i += step) {
    const tick = document.createElement('span')
    tick.classList.add('time-tick')
    tick.style.left = `${(i / duration) * 100}%`
    tick.textContent = `${Math.floor(i / 60)}:${i % 60 < 10 ? '0' + (i % 60) : i % 60}`
    timeScale.appendChild(tick)
  }
}

// Add time scale once the audio is ready
wavesurfer.on('ready', addTimeScale)
</script>

</body>
</html>
